{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Turnierplaner</h2>
  <p>Erzeuge einen Zeitplan für ein Event.</p>
  {% if error %}
    <p class="error">{{ error }}</p>
  {% endif %}
  {% if plan.canceled and plan.canceled|length > 0 %}
    <div class="warning-list">
      <strong>Abgesagte Turniere:</strong>
      <ul>
        {% for c in plan.canceled %}
          <li>{{ c.title }} (ID {{ c.id }}) – {{ c.starters }} Starter · {{ c.reason }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  {% if message %}
    <p class="success">{{ message }}</p>
  {% endif %}
  <form method="post" class="form-grid">
    <label>
      Veranstaltungs-ID
      <input type="text" name="event_id" value="{{ event_id }}" placeholder="z.B. 12345" required>
    </label>
    <label>
      Heat-Größe
      <input type="number" name="heat_size" min="1" max="20" value="{{ heat_size }}">
    </label>
    <label>
      Untergrenze für Absage
      <input type="number" name="cancel_under" min="0" max="50" value="{{ cancel_under }}">
      <small>Turniere mit weniger Startern werden abgesagt</small>
    </label>
    <label>
      <input type="checkbox" name="cancel_enabled" {% if cancel_enabled %}checked{% endif %}> Absagen durchführen
    </label>
    <label>
      <input type="checkbox" name="general_look" {% if general_look %}checked{% endif %}>
      General Look (1&nbsp;Min./Tanz) bei ≤6 Paaren einplanen
    </label>
    <div class="form-actions">
      <button type="submit" name="action" value="generate">Plan erstellen</button>
      {% if plan and plan_source != 'saved' %}
        <button type="submit" name="action" value="save">Plan speichern</button>
      {% endif %}
    </div>
  </form>
  {% if creds_missing %}
    <p class="error">Zugangsdaten fehlen – bitte zuerst im Tab Einstellungen hinterlegen.</p>
  {% endif %}
</section>

{% if plan %}
<section class="panel">
  <div class="panel-header">
    <h3>{{ plan.plan_name or plan.event.name }}</h3>
    <div class="hint">Heat-Größe: {{ plan.heat_size }} · erstellt {{ plan.generated_at }}</div>
  </div>
  {% if plan.warnings %}
    <ul class="warning-list">
      {% for warn in plan.warnings %}
        <li>{{ warn }}</li>
      {% endfor %}
    </ul>
  {% endif %}
  {% for day in plan.days %}
    <article class="plan-day" data-day="{{ day.display_date or day.date }}">
      <h4>{{ day.display_date or day.date }}</h4>
      <label class="day-start-label">Startzeit Tag: <input type="time" class="day-start" value="{{ day.start_time or (day.tournaments[0].start_time if day.tournaments and day.tournaments[0].start_time else '09:00') }}"></label>
      <button type="button" class="btn-add-day">Block (Turnier/Show) hinzufügen</button>
      <table class="tournaments plan-table">
        <thead>
          <tr>
            <th>Zeitraum</th>
            <th>Turnier <span class="tournament-handle">⇅</span></th>
            <th>Starter</th>
            <th>Blöcke</th>
          </tr>
        </thead>
        <tbody>
          {% for tournament in day.tournaments %}
            <tr data-id="{{ tournament.id }}" data-startgruppe="{{ tournament.startgruppe }}" data-startklasse="{{ tournament.startklasse }}" data-wettbewerbsart="{{ tournament.wettbewerbsart }}" data-turnierart="{{ tournament.turnierart }}" class="{% if tournament.canceled %}canceled{% endif %}">
              <td class="time-total">
                <span class="t-start">{{ tournament.start_time }}</span> – <span class="t-end">{{ tournament.end_time }}</span><br>
                <small>ca. <span class="t-total">{{ tournament.total_minutes|round(0) }}</span> Min.</small>
              </td>
              <td>
                <span class="tournament-row-handle">⇅</span>
                <strong contenteditable="true">{{ tournament.title }}</strong><br>
                ID {{ tournament.id }} · {{ tournament.startgruppe }} {{ tournament.startklasse }} · {{ tournament.wettbewerbsart }}
                {% if tournament.reactivated %}<span class="reactivated">(!) reaktiviert</span>{% endif %}
                {% if tournament.description %}<div class="hint">{{ tournament.description }}</div>{% endif %}
                <div class="block-actions">
                  <button type="button" class="btn-cancel-toggle">Absagen/Reaktivieren</button>
                  <button type="button" class="btn-delete-row">Entfernen</button>
                </div>
              </td>
              <td><input type="number" class="manual-starters" min="0" value="{{ tournament.starters }}"></td>
              <td>
                <div class="block-actions">
                  <button type="button" class="btn-add" data-type="custom">Block hinzufügen</button>
                </div>
                <ul class="block-list"
                    data-start-time="{{ tournament.start_time }}"
                    data-default-start="09:00">
                  {% for block in tournament.blocks %}
                    <li class="block-item" data-type="{{ block.type }}">
                      <span class="drag-handle">⇅</span>
                      <input class="block-label" type="text" value="{{ block.label or block.type }}" />
                      <input class="block-minutes" type="number" min="0" step="0.5" value="{{ block.minutes|round(1) }}">
                      {% if block.type == 'round' %}
                        <small>{{ block.couples }} Paare · {{ block.heats }} Heats · Tänze {{ block.dances|join(', ') }}{% if block.cross_info %} · Kreuz: {{ block.cross_info }}{% endif %}</small>
                      {% endif %}
                      <span class="time-range"></span>
                      <button type="button" class="btn-delete">✕</button>
                    </li>
                  {% endfor %}
                </ul>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </article>
  {% endfor %}
  {% if plan.plan_id %}
    <p class="hint">Plan-ID: {{ plan.plan_id }} – Export: <a href="{{ url_for('planner_export', plan_id=plan.plan_id) }}">JSON herunterladen</a></p>
    <form method="post">
      <input type="hidden" name="action" value="save_current">
      <input type="hidden" name="plan_id" value="{{ plan.plan_id }}">
      <input type="hidden" name="plan_payload" id="plan-payload">
      <button type="button" id="save-current">Speichern</button>
    </form>
    <p><a href="{{ url_for('planner', plan_id=plan.plan_id, refresh=1) }}">Daten via ESV aktualisieren</a></p>
  {% endif %}
</section>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  function parseTime(str) {
    if (!str) return { hours: 9, minutes: 0 };
    const parts = str.split(':').map(Number);
    return { hours: parts[0] || 0, minutes: parts[1] || 0 };
  }
  function formatTime(h, m) {
    if (h >= 24) h = h % 24;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }
  function recalcTournament(listEl) {
    const row = listEl.closest('tr');
    const day = row.closest('.plan-day');
    const dayDefault = day?.querySelector('.day-start')?.value || '09:00';
    const startText = listEl.dataset.startTime || listEl.dataset.defaultStart || dayDefault;
    let { hours, minutes } = parseTime(startText);
    let currentMinutes = hours * 60 + minutes;
    let total = 0;
    listEl.querySelectorAll('.block-item').forEach((item) => {
      const minutesInput = item.querySelector('.block-minutes');
      const raw = parseFloat(minutesInput.value) || 0;
      const duration = Math.ceil(raw); // always round up to full minutes
      const startH = Math.floor(currentMinutes / 60);
      const startM = currentMinutes % 60;
      const endMinutes = currentMinutes + duration;
      const endH = Math.floor(endMinutes / 60);
      const endM = endMinutes % 60;
      const trange = item.querySelector('.time-range');
      trange.textContent = ` ${formatTime(startH, startM)}–${formatTime(endH, endM)}`;
      currentMinutes = endMinutes;
      total += duration;
    });
    row.querySelector('.t-start').textContent = startText;
    row.querySelector('.t-end').textContent = formatTime(Math.floor(currentMinutes/60), currentMinutes%60);
    row.querySelector('.t-total').textContent = total.toFixed(0);
  }
  function recalcDay(table) {
    const day = table.closest('.plan-day');
    const defaultStart = day?.querySelector('.day-start')?.value || '09:00';
    let current = parseTime(defaultStart);
    let currentMinutes = current.hours * 60 + current.minutes;
    table.querySelectorAll('tbody tr').forEach((row) => {
      if (row.classList.contains('canceled')) {
        row.querySelector('.t-start').textContent = '--:--';
        row.querySelector('.t-end').textContent = '--:--';
        row.querySelector('.t-total').textContent = '0';
        return;
      }
      const listEl = row.querySelector('.block-list');
      let total = 0;
      if (listEl) {
        listEl.querySelectorAll('.block-item').forEach((item) => {
          const minutesInput = item.querySelector('.block-minutes');
          const raw = parseFloat(minutesInput.value) || 0;
          const duration = Math.ceil(raw);
          const trange = item.querySelector('.time-range');
          const startH = Math.floor(currentMinutes / 60);
          const startM = currentMinutes % 60;
          const endMinutes = currentMinutes + duration;
          const endH = Math.floor(endMinutes / 60);
          const endM = endMinutes % 60;
          if (trange) trange.textContent = ` ${formatTime(startH, startM)}–${formatTime(endH, endM)}`;
          currentMinutes = endMinutes;
          total += duration;
        });
      }
      row.querySelector('.t-start').textContent = formatTime(Math.floor((currentMinutes - total)/60), (currentMinutes - total)%60);
      row.querySelector('.t-end').textContent = formatTime(Math.floor(currentMinutes/60), currentMinutes%60);
      row.querySelector('.t-total').textContent = total.toFixed(0);
      currentMinutes += 0; // gap could be added here if needed
    });
  }

  function attachPlanner() {
    document.querySelectorAll('.block-list').forEach((listEl) => {
      recalcTournament(listEl);
      Sortable.create(listEl, {
        handle: '.drag-handle',
        animation: 150,
        onSort: () => {
          recalcTournament(listEl);
          recalcDay(listEl.closest('.plan-table'));
        },
      });
    });

    document.addEventListener('input', (ev) => {
      if (ev.target.classList.contains('block-minutes')) {
        const listEl = ev.target.closest('.block-list');
        recalcTournament(listEl);
        recalcDay(listEl.closest('.plan-table'));
      }
      if (ev.target.classList.contains('manual-starters')) {
        recalcDay(ev.target.closest('.plan-table'));
      }
    });

    
    document.addEventListener('change', (ev) => {
      if (ev.target.classList.contains('day-start')) {
        const container = ev.target.closest('.plan-day');
        const table = container.querySelector('.plan-table');
        const value = ev.target.value || '09:00';
        container.querySelectorAll('.block-list').forEach((listEl) => {
          listEl.dataset.defaultStart = value;
          if (!listEl.dataset.startTime || listEl.dataset.startTime === '') {
            listEl.dataset.startTime = value;
          }
        });
        recalcDay(table);
      }
    });
document.addEventListener('click', (ev) => {
      if (ev.target.classList.contains('btn-delete')) {
        const listEl = ev.target.closest('.block-list');
        ev.target.closest('.block-item').remove();
        recalcTournament(listEl);
        recalcDay(listEl.closest('.plan-table'));
      }
      if (ev.target.classList.contains('btn-add')) {
        const listEl = ev.target.closest('td').querySelector('.block-list');
        const li = document.createElement('li');
        li.className = 'block-item';
        li.dataset.type = 'custom';
        li.innerHTML = `
          <span class="drag-handle">⇅</span>
          <input class="block-label" type="text" value="Block" />
          <input class="block-minutes" type="number" min="0" step="0.5" value="5">
          <span class="time-range"></span>
          <button type="button" class="btn-delete">✕</button>
        `;
        listEl.appendChild(li);
        recalcTournament(listEl);
        recalcDay(listEl.closest('.plan-table'));
      }
      if (ev.target.classList.contains('btn-cancel-toggle')) {
        const row = ev.target.closest('tr');
        row.classList.toggle('canceled');
        recalcDay(ev.target.closest('.plan-table'));
      }
      if (ev.target.classList.contains('btn-delete-row')) {
        const table = ev.target.closest('.plan-table');
        ev.target.closest('tr').remove();
        recalcDay(table);
      }
    });

    // Add Sortable to whole day (tournaments)
    document.querySelectorAll('.plan-table tbody').forEach((tbody) => {
      Sortable.create(tbody, {
        handle: '.tournament-row-handle',
        animation: 150,
        onSort: () => recalcDay(tbody.closest('.plan-table')),
      });
    });

    // add whole-block (as tournament) to a day
    document.querySelectorAll('.btn-add-day').forEach((btn) => {
      btn.addEventListener('click', () => {
        const container = btn.closest('.plan-day');
        const table = container.querySelector('.plan-table');
        const tbody = table.querySelector('tbody');
        const nowId = `BLOCK-${Date.now()}`;
        const row = document.createElement('tr');
        row.dataset.id = nowId;
        row.dataset.startgruppe = '';
        row.dataset.startklasse = '';
        row.dataset.wettbewerbsart = '';
        row.dataset.turnierart = '';
        row.innerHTML = `
          <td class="time-total">
            <span class="t-start">--:--</span> – <span class="t-end">--:--</span><br>
            <small>ca. <span class="t-total">0</span> Min.</small>
          </td>
          <td>
            <span class="tournament-row-handle">⇅</span>
            <strong contenteditable="true">Sonderblock</strong><br>
            <span class="hint">ID ${nowId}</span>
            <div class="hint"><input class="block-desc" type="text" placeholder="Beschreibung (intern)"></div>
            <div class="block-actions">
              <button type="button" class="btn-cancel-toggle">Absagen/Reaktivieren</button>
              <button type="button" class="btn-delete-row">Entfernen</button>
            </div>
          </td>
          <td><input type="number" class="manual-starters" min="0" value="0"></td>
          <td>
            <ul class="block-list" data-start-time="09:00" data-default-start="09:00">
              <li class="block-item" data-type="custom">
                <span class="drag-handle">⇅</span>
                <input class="block-label" type="text" value="Block" />
                <input class="block-minutes" type="number" min="0" step="0.5" value="10">
                <span class="time-range"></span>
                <button type="button" class="btn-delete">✕</button>
              </li>
            </ul>
          </td>
        `;
        tbody.appendChild(row);
        const listEl = row.querySelector('.block-list');
        const dayStart = container.querySelector('.day-start')?.value || '09:00';
        listEl.dataset.defaultStart = dayStart;
        recalcTournament(listEl);
        recalcDay(table);
      });
    });

    const saveBtn = document.getElementById('save-current');
    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        const plan = { days: [] };
        document.querySelectorAll('.plan-day').forEach((dayEl) => {
          const date = dayEl.dataset.day;
          const dayStartInput = dayEl.querySelector('.day-start');
          const dayStartVal = dayStartInput?.value || '09:00';
          const dayData = { date, start_time: dayStartVal, tournaments: [] };
          dayEl.querySelectorAll('tbody tr').forEach((row) => {
            const title = row.querySelector('td:nth-child(2) strong')?.textContent?.trim();
            const tId = row.dataset.id || '';
            const blocks = [];
            row.querySelectorAll('.block-item').forEach((item) => {
              blocks.push({
                type: item.dataset.type,
                label: item.querySelector('.block-label')?.value || '',
                minutes: parseFloat(item.querySelector('.block-minutes')?.value || '0'),
              });
            });
            const starterInput = row.querySelector('.manual-starters');
            const startersVal = starterInput ? starterInput.value : (row.querySelectorAll('td')[2]?.textContent?.trim() || '');
            const isCanceled = row.classList.contains('canceled');
            const hasContent = (title && title.length > 0) || blocks.length > 0;
            if (!isCanceled && !hasContent) {
              return;
            }
            dayData.tournaments.push({
              id: tId,
              title,
              startgruppe: row.dataset.startgruppe || '',
              startklasse: row.dataset.startklasse || '',
              wettbewerbsart: row.dataset.wettbewerbsart || '',
              turnierart: row.dataset.turnierart || '',
              canceled: isCanceled,
              start_time: row.querySelector('.t-start')?.textContent || '',
              end_time: row.querySelector('.t-end')?.textContent || '',
              total_minutes: parseFloat(row.querySelector('.t-total')?.textContent || '0'),
              description: row.querySelector('.block-desc')?.value || '',
              starters: startersVal,
              blocks,
            });
          });
          if (dayData.tournaments.length > 0) {
            plan.days.push(dayData);
          }
        });
        document.getElementById('plan-payload').value = JSON.stringify(plan);
        saveBtn.closest('form').submit();
      });
    }
  }
  document.addEventListener('DOMContentLoaded', attachPlanner);
</script>
{% endif %}

<section class="panel">
  <h3>Gespeicherte Pläne</h3>
  {% if saved_plans %}
    <table class="tournaments plan-table">
      <thead>
        <tr>
          <th>Plan-ID</th>
          <th>Name</th>
          <th>Veranstaltung</th>
          <th>Erstellt</th>
          <th>Heat-Größe</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        {% for saved in saved_plans|sort(attribute='created_at', reverse=True) %}
          <tr>
            <td>{{ saved.id }}</td>
            <td>
              <form method="post" class="inline-form">
                <input type="hidden" name="action" value="rename_plan">
                <input type="hidden" name="plan_id" value="{{ saved.id }}">
                <input type="text" name="plan_name" value="{{ saved.plan_name or saved.event_name }}" size="18">
                <button type="submit">Umbenennen</button>
              </form>
            </td>
            <td>{{ saved.event_name }}</td>
            <td>{{ saved.created_at }}</td>
            <td>{{ saved.heat_size }}</td>
            <td>
              <a href="{{ url_for('planner', plan_id=saved.id) }}">Anzeigen</a> ·
              <a href="{{ url_for('planner_export', plan_id=saved.id) }}">Export</a>
              <form method="post" class="inline-form" onsubmit="return confirm('Plan wirklich löschen?');">
                <input type="hidden" name="action" value="delete_plan">
                <input type="hidden" name="plan_id" value="{{ saved.id }}">
                <button type="submit">Löschen</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Noch keine Pläne gespeichert.</p>
  {% endif %}
</section>
{% endblock %}
