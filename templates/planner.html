{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Turnierplaner</h2>
  <p>Erzeuge einen Zeitplan je Veranstaltung. Die Rundenstruktur lässt sich über <code>planner_rules.xml</code> anpassen.</p>
  {% if error %}
    <p class="error">{{ error }}</p>
  {% endif %}
  {% if message %}
    <p class="success">{{ message }}</p>
  {% endif %}
  <form method="post" class="form-grid">
    <label>
      Veranstaltungs-ID
      <input type="text" name="event_id" value="{{ event_id }}" placeholder="z.B. 12345" required>
    </label>
    <label>
      Heat-Größe
      <input type="number" name="heat_size" min="1" max="20" value="{{ heat_size }}">
      <small>Standard: {{ default_heat_size }}</small>
    </label>
    <div class="form-actions">
      <button type="submit" name="action" value="generate">Plan erstellen</button>
      {% if plan and plan_source != 'saved' %}
        <button type="submit" name="action" value="save">Plan speichern</button>
      {% endif %}
    </div>
  </form>
  {% if creds_missing %}
    <p class="error">Zugangsdaten fehlen – bitte zuerst im Tab Einstellungen hinterlegen.</p>
  {% endif %}
</section>

{% if plan %}
<section class="panel">
  <div class="panel-header">
    <h3>Plan für {{ plan.event.name or ('Veranstaltung ' ~ plan.event.id) }}</h3>
    <div class="hint">Heat-Größe: {{ plan.heat_size }} · erstellt {{ plan.generated_at }}</div>
  </div>
  {% if plan.warnings %}
    <ul class="warning-list">
      {% for warn in plan.warnings %}
        <li>{{ warn }}</li>
      {% endfor %}
    </ul>
  {% endif %}
  {% for day in plan.days %}
    <article class="plan-day">
      <h4>{{ day.date }}</h4>
      <table class="tournaments plan-table">
        <thead>
          <tr>
            <th>Zeitraum</th>
            <th>Turnier</th>
            <th>Starter</th>
            <th>Runden</th>
          </tr>
        </thead>
        <tbody>
          {% for tournament in day.tournaments %}
            <tr>
              <td>{{ tournament.start_time }} – {{ tournament.end_time }}<br><small>ca. {{ tournament.total_minutes|round(1) }} Min.</small></td>
              <td>
                <strong>{{ tournament.title }}</strong><br>
                ID {{ tournament.id }} · {{ tournament.startgruppe }} {{ tournament.startklasse }} · {{ tournament.wettbewerbsart }}
              </td>
              <td>{{ tournament.starters }}</td>
              <td>
                <ul>
                  {% for round in tournament.rounds %}
                    <li>
                      {{ round.name }}: {{ round.couples }} Paare · {{ round.heats }} Heats · Tänze {{ round.dances|join(', ') }} · ≈ {{ round.minutes|round(1) }} Min.
                      {% if round.cross_info %}<br><small>Kreuzvorgabe: {{ round.cross_info }}</small>{% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </article>
  {% endfor %}
  {% if plan.plan_id %}
    <p class="hint">Plan-ID: {{ plan.plan_id }} – Export: <a href="{{ url_for('planner_export', plan_id=plan.plan_id) }}">JSON herunterladen</a></p>
  {% endif %}
</section>
{% endif %}

<section class="panel">
  <h3>Gespeicherte Pläne</h3>
  {% if saved_plans %}
    <table class="tournaments plan-table">
      <thead>
        <tr>
          <th>Plan-ID</th>
          <th>Veranstaltung</th>
          <th>Erstellt</th>
          <th>Heat-Größe</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        {% for saved in saved_plans|sort(attribute='created_at', reverse=True) %}
          <tr>
            <td>{{ saved.id }}</td>
            <td>{{ saved.event_name }}</td>
            <td>{{ saved.created_at }}</td>
            <td>{{ saved.heat_size }}</td>
            <td>
              <a href="{{ url_for('planner', plan_id=saved.id) }}">Anzeigen</a> ·
              <a href="{{ url_for('planner_export', plan_id=saved.id) }}">Export</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Noch keine Pläne gespeichert.</p>
  {% endif %}
</section>
{% endblock %}
